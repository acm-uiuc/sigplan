machine:
  ghc:
    version: 7.10.1

dependencies:
  cache_directories:
    - "/usr/bin/stack"
    - "~/.stack"
    - ".stack-work"
  override:
    - if ! test -x /usr/bin/stack; then touch /tmp/dl; fi
    - test -e /tmp/dl && curl -L https://github.com/commercialhaskell/stack/releases/download/v1.0.4/stack-1.0.4-linux-x86_64.tar.gz | tar zx -C /tmp
    - test -e /tmp/dl && sudo mv /tmp/stack-1.0.4-linux-x86_64/stack /usr/bin
    - rm /tmp/dl
    - sudo apt-get update
    - sudo apt-get install gcc4.8 lua5.2 liblua5.2 liblua5.2-dev
    - stack --no-terminal setup
    - stack --no-terminal install hslua --flag "hslua:system-lua"
    - stack --no-terminal install --only-dependencies --flag "hslua:system-lua"

test:
  override:
    - stack --no-terminal install --only-dependencies --flag "hslua:system-lua"
    - stack --no-terminal build
  post:
    - git submodule init
    - git submodule update
    - cd _site/ && git checkout gh-pages
    - ./dist/build/site/site build

deployment:
  production:
    branch: hakyll
    commands:
      - git config --global user.email circleci@circleci
      - git config --global user.name CircleCI
      - cd _site/ && git status
      - cd _site/ && git add --all
      - cd _site/ && git commit -m "Update (`date '+%F %T %Z'`) [ci skip]"
      - cd _site/ && git push origin gh-pages
      - git status
      - git add _site/
      - git commit -m "Update _site (`date '+%F %T %Z'`) [ci skip]"
      - git push origin hakyll
