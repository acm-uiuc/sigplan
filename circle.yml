machine:
  ghc:
    version: 7.10.1
  environment:
    githubURL:     https://github.com
    stackOwner:    commercialhaskell
    stackRepo:     stack
    stackVersion:  1.0.4
    stackPlatform: linux
    stackArch:     x86_64
    foo:           baz
    bar:           $foo-quux

dependencies:
  cache_directories:
    - "/usr/bin/stack"
    - "~/.stack"
    - ".stack-work"
  override:
    - echo "$githubURL/$tackOwner/$stackRepo/releases/download/v$stackVersion/stack-$stackVersion-$stackPlatform-$stackArch.tar.gz"
    - echo "$foo"
    - echo "$bar"
    - exit -1
    - if ! test -x /usr/bin/stack; then touch /tmp/dl; fi
    - test -e /tmp/dl && curl -L  | tar zx -C /tmp
    - test -e /tmp/dl && sudo mv /tmp/stack-1.0.4-linux-x86_64/stack /usr/bin
    - test -e /tmp/dl && rm /tmp/dl
    - sudo apt-get update
    - sudo apt-get install gcc lua5.2 liblua5.2-0 liblua5.2-dev
    - stack --no-terminal setup
    - stack --no-terminal install hslua
    - stack --no-terminal install --only-dependencies

test:
  override:
    - stack --no-terminal build
  post:
    - git submodule init
    - git submodule update
    - cd _site/ && git checkout gh-pages
    - $(stack path --dist-dir)/build/site/site build

deployment:
  production:
    branch: hakyll
    commands:
      - git config --global user.email circleci@circleci
      - git config --global user.name CircleCI
      - cd _site/ && git status
      - cd _site/ && git add --all
      - cd _site/ && git commit -m "Update (`date '+%F %T %Z'`) [ci skip]"
      - cd _site/ && git push origin gh-pages
      - git status
      - git add _site/
      - git commit -m "Update _site (`date '+%F %T %Z'`) [ci skip]"
      - git push origin hakyll
